#!/bin/bash
# ~/pettil/tools/mkperturb
#
cd ~/pettil >/dev/null

#pets=$(pgrep -x x\(pet\|vic\|64sc\|128\|plus4\))
#while [ "${pets}" ]; do
#    echo -n .
#    sleep 1
#    pets=$(pgrep -x x\(pet\|vic\|64sc\|128\|plus4\))
#done
#echo

date -Iseconds >> ./perturb.log

for object in ./tmp/perturb/perturb.*.png
do
    cheese=$(basename ${object#*/})

    if [ ! -f data/perturb/${cheese} ]; then
#        display ${object}
        echo -e "fail 🍅 ${cheese}\t-- not in data/perturb!"                                    \
        >> ./perturb.log
    fi

    diff -s -b ./tmp/perturb/${cheese} ./data/perturb/                          \
    |sed 's/^.*\/\(.*\)\ are\ identical$/pass 🥑 \1/'                                \
    |sed 's/^.*\/\(.*\)\ differ$/fail 🍅 \1 \t\t...different!/'                      \
    >> ./perturb.log
done

for object in ./data/perturb/perturb.*.png
do
    cheese=$(basename ${object#*/})
    echo ${cheese}
    if [ ! -f tmp/perturb/${cheese} ]; then
#        display ${object}
        echo -e "fail 🍅 ${cheese}\t-- not in tmp/perturb!"                                    \
        >> ./perturb.log
    fi
done
exit

awk '/^2([[:digit:]])+/ {c=NR; a=$0;next} END { { print c } }' ./perturb.log    \
  | xargs -I{} awk 'BEGIN {FS="[T .-]"; ORS="\r";x=ARGV[2]}                     \
  { if (NR==x)                                                                  \
      {  OFS=""; print "\x22",$1,"/",$2,"/",$3," ",$4,"\x22"};                  \
    if (NR>x)                                                                   \
      { OFS=","; print $1,$4,$5}                                                \
  } ' ./perturb.log {}                                                          \
  >obj/perturb/results.dat 2>/dev/null
